
// Log4j Vulnerability Exploit Detection (Log4Shell IP IOC)
// This query identifies potential Log4j exploitation attempts by matching
// inbound connections against known malicious IP addresses associated with Log4Shell activity.

let ioc_list = ThreatIntelligenceIndicator
| where Active == true
| where Description has "Log4j" or Description has "Log4Shell" or ThreatType contains "Log4j"
| where isnotempty(NetworkIP)
| project IOC_IP = NetworkIP, Description, ThreatType, ExpirationDateTime;

// Match against Azure activity logs
union isfuzzy=true
(
    AzureDiagnostics
    | extend SourceIP = tostring(parse_json(Properties_s).clientIpAddress)
    | where isnotempty(SourceIP)
),
(
    CommonSecurityLog
    | extend SourceIP = SourceIP
    | where isnotempty(SourceIP)
),
(
    SigninLogs
    | extend SourceIP = IPAddress
    | where isnotempty(SourceIP)
)
| join kind=inner ioc_list on $left.SourceIP == $right.IOC_IP
| project
    Timestamp = TimeGenerated,
    SourceIP,
    ThreatDescription = Description,
    ThreatType,
    ExpirationDateTime,
    LogSource = SourceSystem,
    Resource,
    ResourceId,
    OperationName,
    _ResourceId,
    AccountCustomEntity = tostring(parse_json(Properties_s).userPrincipalName),
    IPCustomEntity = SourceIP
